# Bugs

# Features
- [x] brief instructions in 'waiting for black to join' modal about sharing the game URL
- [x] make "page doesnt exist html
- [x] revert coloring of recent move squares so that white and black squares are differentiated
- [ ] enable reconnecting instead of 'abandoned' when you leave
  - [x] front end
    - [x] store some info in localStorage
      - [x] uid
      - [x] side
    - [x] make sure to clear this info out when a game is actually over
    - [x] on reconnect/reload, check if there's
        - [x] a UID in localStorage which matches the current one
        - [x] side
        - [x] a timestamp less than X minutes old
    - [x] on disconnect,
        - [x] try to reconnect in front end for a few mins, (as seen here)[https://stackoverflow.com/a/23176223/4386191]
        - [x] 'rejoin_success' case
        - [x] remove all the event listeners on ws 'close'
        - [x] board.disableMoveInput();
        - [x] store a timestamp for when it disconnected
        - [x] display what's happening in displayMessage 
        - [x] display countdown
        - [x] if it times out
          - [x] clearLocalStorage
          - [x] send message that the game should be over
    - [x] handle 'disconnect' message from WS server which it will send if other player disconnects
      - [x] replicate the logic for displaying the message and countdown
  - [ ] back end
    - [ ] when a player disconnects, don't end the game and don't clear out the entry in CONNECTIONS and ...
    - [ ] instead, see if the UID they're supplying is valid and if there's a player missing
    - [ ] tell other players/watchers about the disconnection to start the countdown
    - [ ] when a user connects, see if they've sent 
      - [ ] the UID 
      - [ ] the side
      - [ ] the correct disconnected_timestamp, give or take
      - [ ] send 'rejoin_success'
    - [ ] enforce the same timeout on the back end as on the front end for reconnecting
      - [ ] use a store in redis, maybe with actual expiry
    - [ ] send a timeout from the back end once the game is truly over because time has run out
      - [ ] how?
- [ ] anonymous matchups
- [ ] move history
- [ ] use promotion dialog that's built into cm-chessboard
- [ ] build out the site, make it look nice
  - [ ] nav bar
- [ ] some basic rate limiting/IP-banning
- [ ] game clock
  - [ ] need to send an 'ack'(knowledged) message when the curernt player receives the previous move of the other player
- [ ] material tracking - points, pieces
  - consider using [these web components](https://shoelace.style/) for straightforward, buildless dev.
- [ ] accounts/auth [link](https://websockets.readthedocs.io/en/10.4/topics/authentication.html#sending-credentials)
- [ ] show YOUR active game(s) on home page
- [ ] enforce move limit (draw)
- [ ] allow players to choose which side they're on
- [ ] expire games in redis if they haven't been joined in X mins
  - [ ] alternatively, don't allow the creation of a game if you're already in one
- [ ] stockfish
- [ ] instead of 'white has rejected black's draw offer', 'white has rejected your draw offer'
- [ ] use cookies instead of localStorage for reconnecting

# Deployment
- [ ] create `init_db_prod.py` script 
- [ ] incorporate alembic and start doing DB migrations when there's a schema change
- [ ] ideally, detect if there's a change to `ztypes.GameState.to_db_dict`'s keys without a corresponding migration

# Optimization
- [ ] add some kind of analytics/logging
  - [ ] number of concurrent games
  - [ ] memory usage with alerts
- [ ] load testing
- [ ] find shortcuts to limit computation, storage, and bytes over the wire
  - [ ] profile the running code
    - [ ] number of computations for each move
    - [ ] how long does it take to process a move?
  - [ ] any advantage in pub/sub (redis) for games?
  - [ ] cache possible moves for every board
    - [ ] look in this cache before trying to calculate
  - [ ] persist/serialize the board differently
    - instead of FEN, maybe a hash
    - [bitboard](https://blog.devgenius.io/improve-as-a-software-engineer-by-writing-a-chess-engine-c360109371aa)
      - there are bit operations in redis, si jamais
  - [ ] use a CDN
- [ ] distribute across many services
  - [ ] move the two CONNECTION stores in `ws_server.py` distributable, not sure how! (keep them in a load balancer?)
  - [ ] more practically, [use a message queue](https://stackoverflow.com/a/44428469)
